---
interface Props {
    stops: string[];
    links?: string[];
    current?: string | number;
    accessibility?: number[];
    options?: { centerOnCurrent?: boolean };
}

const { stops = [], links = [], current = 0, accessibility = [], options = { centerOnCurrent: true } } = Astro.props;
let currentIndex = typeof current === "number" ? current : stops.indexOf(current);
if (currentIndex < 0) currentIndex = 0;
const total = Math.max(stops.length - 1, 1);
const progressPercent = (currentIndex / total) * 100;
---

<style>
    .topbar-row {
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-top: 16px;
        padding-right: 16px;
        padding-left: 16px;
    }
    
    .sidebar-box {
        width: 160px;
        height: min(100px, 20vh);
        background: #000;
    }

    .topbar {
        position: sticky;
        top: 18px;
        margin: 0 auto;
        width: min(860px, 50%);
        height: min(100px, 17vh);
        z-index: 999;
        background: #000;
        padding: 14px;
        padding-top: 0;
        padding-left: 25px;
        padding-right: 80px;
        border: 3px solid #111;
        border-radius: 3px;
    }

    .header {
        display: flex;
        align-items: baseline;
        gap: 8px;
        transform: rotat(-45deg);
        margin-bottom: 10px;
        overflow: visible;
        height: auto;
    }

    .next-label {
        font-size: 0.90rem;
        color: #fff;
        font-weight: 700;
        transform: rotate(-45deg);
        position: relative;
        top: 25px;
        left: -20px;
    }

    .current-stop-wrap {
        position: relative;
        height: 34px;
        min-width: 180px;
        overflow: visible;
    }

    .current-stop {
        position: absolute;
        top: 0;
        left: 0;
        transform: translateY(0);
        display: flex;
        gap: 10px;
        align-items: center;
        white-space: nowrap;
        font-weight: 800;
        font-size: 1.05rem;
        color: #ffffff;
    }

    .current-stop .tiny {
        font-size: 0.82rem;
        color: #bcdffd;
        font-weight: 700;
        opacity: 0.95;
    }

    .strip-wrap {
        position: relative;
        width: 100%;
        height: 90px;
    }

    .strip {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 100%;
        height: 9px;
        background: #1d4ed8;
        border-radius: 3px;
        z-index: 2;
    }

    .progress {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 6px;
        border-radius: 3px;
        background: #1d4ed8; 
        width: var(--progress, 0%);
        z-index: 3;
        transition: width 520ms cubic-bezier(.22,.9,.32,1);
    }

    .dots {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 100%;
        height: 6px;
        z-index: 4;
        pointer-events: auto;
    }

    .dot-wrapper {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
    }

    .label {
        position: absolute;
        top: -20px;
        left: 25px;
        transform: rotate(-45deg);
        transform-origin: left center;
        font-size: 1rem;
        color: #d7d9dd;
        white-space: nowrap;
        pointer-events: auto;
        z-index: 12;
    }

    .dot-wrapper:hover .label {
        text-decoration: underline;
    }

    .dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid #1d4ed8;
        background: #e6e6e6;
        box-sizing: border-box;
        transition: background 380ms;
    }

    .dot.past { background: #a8a8a8; }
    .dot.current { background: #000000; border-color: #e6e6e6; }
    .dot.future { background: #e6e6e6; }

    .label.faint { opacity: 0.6; color: #9aa0a6; }

    .diag-line {
        position: absolute;
        width: 120px;
        height: 16.5px;
        background: #1d4ed8;
        top: 50%;
        left: 0%;
        transform: translate(-24px, -46px) rotate(-45deg);
        border-radius: 15px;
        border: 1px solid #111;
        z-index: 3; 
    }


</style>

<div class="topbar-row">
    <div class="sidebar-box"></div>
    <div class="topbar" role="region" aria-label="Strip map">
        <div class="header">
            <div class="next-label">NEXT STOP</div>
            <div class="current-stop-wrap" id="currentStopWrap" aria-live="polite">
            </div>
        </div>

        <div class="strip-wrap" id="stripWrap">
            <div class="strip" aria-hidden></div>
            <div class="diag-line"></div>
            <div class="progress" id="progressBar" style={`--progress: ${progressPercent}%`}></div>

            <div class="dots" id="dotsLayer" aria-hidden>
                {stops.map((stop, i) => {
                    const idx = i;
                    const leftPercent = (idx / total) * 100;
                    const state = i < currentIndex ? "past" : i === currentIndex ? "current" : "future";

                    return (
                        <Fragment>
                            <div
                            class="dot-wrapper"
                            style={`left: ${leftPercent}%;`}
                            >
                                <a
                                    href={links[i] ?? stop}
                                    class="dot-wrapper"
                                    style={`left: ${leftPercent}%;`}
                                >
                                    <div class={`label ${i < currentIndex - 3 ? "faint" : ""}`}>
                                        {stop}
                                    </div>

                                    <div class={`dot ${state}`}></div>
                                </a>
                            </div>
                        </Fragment>
                    );
                })}
            </div>
        </div>
    </div>
</div>

<script>
    declare global {
        interface Window {
            setStripCurrent: (index: number) => void;
        }
    }

    (function () {
        const stops = JSON.parse(`{JSON.stringify(stops)}`);
        const links = JSON.parse(`{JSON.stringify(links)}`);
        const total = Math.max(stops.length - 1, 1);
        let currentIndexState = Number("{ currentIndex }");
        const dotsLayer = document.getElementById("dotsLayer");
        const progressBar = document.getElementById("progressBar");
        const currentStopText = document.getElementById("currentStopText");
        const currentStopInner = document.getElementById("currentStopInner");
        const stripWrap = document.getElementById("stripWrap");

        if (!dotsLayer || !progressBar || !currentStopText || !currentStopInner || !stripWrap) {
            console.error("Required DOM elements not found");
            return;
        }

        function centerOn(index: number, animate = true): void {
            const wrapWidth = stripWrap.clientWidth;
            const leftPercent = (index / total) * 100;
            const dotX = (leftPercent / 100) * wrapWidth;
            const targetX = wrapWidth / 2 - dotX;
            if (animate) {
                dotsLayer.style.transition = 'transform 560ms cubic-bezier(.22,.9,.32,1)';
                progressBar.style.transition = 'width 520ms cubic-bezier(.22,.9,.32,1)';
                currentStopInner.style.transition = 'transform 380ms cubic-bezier(.22,.9,.32,1)';
            } else {
                dotsLayer.style.transition = 'none';
                progressBar.style.transition = 'none';
                currentStopInner.style.transition = 'none';
            }
            dotsLayer.style.transform = `translateX(${targetX}px)`;
            progressBar.style.width = `${(index / total) * 100}%`;
            currentIndexState = index;
            currentStopText.textContent = stops[index] ?? "";
            currentStopInner.style.transform = 'translateX(-8px)';
            requestAnimationFrame(() => {
                currentStopInner.style.transform = 'translateX(0)';
            });
        }

        centerOn(currentIndexState, false);

        window.setStripCurrent = function (index: number): void {
            if (typeof index !== 'number') return;
            index = Math.max(0, Math.min(index, stops.length - 1));
            centerOn(index, true);
        };

        window.addEventListener('resize', () => {
            centerOn(currentIndexState, false);
        });
    })();
</script>
