---
interface Props {
    stops: string[];
    links?: string[];
    current?: string | number;
}

const { stops = [], links = [], current = 0 } = Astro.props;
let currentIndex = typeof current === "number" ? current : stops.indexOf(current);
if (currentIndex < 0) currentIndex = 0;
const total = Math.max(stops.length - 1, 1);
---

<style>
    :host {
        display: block;
        width: 100%;
        height: 100%;
        min-width: 0;
    }

    :root {
        --design-width: 600;
        --scale: 1;
    }

    .topbar {
        width: 100%;
        height: 100%;
        min-height: 110px;
        border: 3px solid #ff4507;
        box-sizing: border-box;
        padding: 0.5rem 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        container-type: inline-size;
    }

    .header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .next-label {
        font-size: calc(0.95rem * var(--scale));
        color: #1d4ed8;
        font-weight: 700;
        transform: rotate(-45deg) translate(calc(-36px * var(--scale)), calc(35px * var(--scale)));
        transform-origin: left center;
        white-space: nowrap;
    }

    .strip-wrap {
        position: relative;
        flex: 1;
        display: flex;
        align-items: center;
        min-width: 0;
        --strip-y-offset: calc(15px * var(--scale));
        --edge-safe: calc(56px * var(--scale));
        --edge-left: calc(10px * var(--scale));
        --diag-x: calc(15px * var(--scale));
        --diag-y: calc(1px * var(--scale));
    }

    .strip {
        position: absolute;
        left: var(--edge-left);
        width: calc(100% - var(--edge-safe) - var(--edge-left));
        height: calc(9px * var(--scale));
        background: #1d4ed8;
        border-radius: calc(3px * var(--scale));
        z-index: 1;
        transform: translateY(var(--strip-y-offset));
    }

    .dots {
        position: absolute;
        inset: 0;
        z-index: 3;
        left: var(--edge-left);
        width: calc(100% - var(--edge-safe) - var(--edge-left));
    }

    .dot-wrapper {
        position: absolute;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        pointer-events: auto;
        top: calc(50% + var(--strip-y-offset))
    }

    .label {
        position: absolute;
        top: calc(-1.1em * var(--scale));
        left: calc(1.7em * var(--scale));
        transform: rotate(-45deg);
        transform-origin: left center;
        font-weight: 700;
        font-size: calc(0.80rem * var(--scale));
        color: #d7d9dd;
        white-space: nowrap;
        max-width: 8em;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .label.faint { 
        opacity: 0.6; 
        color: #9aa0a6; 
    }


    .dot-wrapper:hover .label {
        text-decoration: underline;
    }

    .dot {
        width: calc(16px * var(--scale));
        height: calc(16px * var(--scale));
        border-radius: 50%;
        border: calc(3px * var(--scale)) solid #1d4ed8;
        background: #e6e6e6;
        box-sizing: border-box;
    }

    .dot.past { background: #a8a8a8; }
    .dot.current { 
        background: #000000; 
        border-color: #e6e6e6; 
    }
    .dot.future { background: #000000; }

    .diag-line {
        position: absolute;
        width: calc(110px * var(--scale));
        height: calc(16px * var(--scale));
        background: #1d4ed8;
        transform: translate( calc(-25% + var(--diag-x)), calc(-180% + var(--strip-y-offset) + var(--diag-y))) rotate(-45deg);
        border-radius: 999px;
        border: 2px solid #111;
        z-index: 2; 
    }
    

    @container (inline-size < 600px) {
        .topbar {
            --scale: clamp(0.6, calc(100cqi / var(--design-width)), 1);
        }
    }

    @container (inline-size >= 600px) {
        .topbar {
            --scale: 1;
        }
    }

</style>

<div class="topbar" role="region" aria-label="Strip map">
    <div class="header">
        <div class="next-label">NEXT STOP</div>
    </div>

    <div class="strip-wrap" id="stripWrap">
        <div class="strip"></div>
        <div class="diag-line"></div>

        <div class="dots" id="dotsLayer" aria-hidden>
            {stops.map((stop, i) => {
                const left = (i / total) * 100;
                const state = i < currentIndex ? "past" : i === currentIndex ? "current" : "future";

                return (
                    <a
                        href={links[i] ?? stop}
                        class="dot-wrapper"
                        style={`left: ${left}%;`}
                    >
                        <div class={`label ${i < currentIndex - 3 ? "faint" : ""}`}>
                            {stop}
                        </div>

                        <div class={`dot ${state}`}></div>
                    </a>
                );
            })}
        </div>
    </div>
</div>

<script>
    declare global {
        interface Window {
            setStripCurrent: (index: number) => void;
        }
    }

    (function () {
        const stops = JSON.parse(`${JSON.stringify(stops)}`);
        const links = JSON.parse(`${JSON.stringify(links)}`);
        const total = Math.max(stops.length - 1, 1);
        let currentIndexState = Number("{ currentIndex }");
        const dotsLayer = document.getElementById("dotsLayer");
        const progressBar = document.getElementById("progressBar");
        const currentStopText = document.getElementById("currentStopText");
        const currentStopInner = document.getElementById("currentStopInner");
        const stripWrap = document.getElementById("stripWrap");

        if (!dotsLayer || !progressBar || !currentStopText || !currentStopInner || !stripWrap) {
            console.error("Required DOM elements not found");
            return;
        }

        function centerOn(index: number, animate = true): void {
            const wrapWidth = stripWrap.clientWidth;
            const leftPercent = (index / total) * 100;
            const dotX = (leftPercent / 100) * wrapWidth;
            const targetX = wrapWidth / 2 - dotX;
            if (animate) {
                dotsLayer.style.transition = 'transform 560ms cubic-bezier(.22,.9,.32,1)';
                progressBar.style.transition = 'width 520ms cubic-bezier(.22,.9,.32,1)';
                currentStopInner.style.transition = 'transform 380ms cubic-bezier(.22,.9,.32,1)';
            } else {
                dotsLayer.style.transition = 'none';
                progressBar.style.transition = 'none';
                currentStopInner.style.transition = 'none';
            }
            dotsLayer.style.transform = `translateX(${targetX}px)`;
            progressBar.style.width = `${(index / total) * 100}%`;
            currentIndexState = index;
            currentStopText.textContent = stops[index] ?? "";
            currentStopInner.style.transform = 'translateX(-8px)';
            requestAnimationFrame(() => {
                currentStopInner.style.transform = 'translateX(0)';
            });
        }

        centerOn(currentIndexState, false);

        window.setStripCurrent = function (index: number): void {
            if (typeof index !== 'number') return;
            index = Math.max(0, Math.min(index, stops.length - 1));
            centerOn(index, true);
        };

        window.addEventListener('resize', () => {
            centerOn(currentIndexState, false);
        });
    })();
</script>
